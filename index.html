<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Time Tracker Widget</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #CDB4DB;
      --text-color: #4a4a4a;
      --sub-text-color: #888888;
      --border-color: #f0f0f0;
      --hover-bg: #f9f9f9;
      --widget-bg: #FAF8FC;
    }

    body[data-theme="purple"] { --primary-color: #CDB4DB; --widget-bg: #FAF8FC; }
    body[data-theme="blue"] { --primary-color: #A8DADC; --widget-bg: #F5FAFB; }
    body[data-theme="pink"] { --primary-color: #FFB3C1; --widget-bg: #FFF9FA; }
    body[data-theme="green"] { --primary-color: #B8E0B8; --widget-bg: #F7FCF7; }
    body[data-theme="yellow"] { --primary-color: #FFD97D; --widget-bg: #FFFEF8; }
    body[data-theme="gray"] { --primary-color: #B8B8B8; --widget-bg: #FAFAFA; }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: transparent;
      color: var(--text-color);
      padding: 12px;
      max-width: 280px;
      margin: 0 auto;
    }

    body.modal-open { overflow: hidden; }

    .widget-container {
      background: var(--widget-bg);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border: 1px solid #f5f5f5;
    }

    .widget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding: 6px 0;
    }

    .widget-header h2 {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .timer-status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--border-color);
    }

    .status-dot.active {
      background: var(--primary-color);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.9); }
    }

    .status-text {
      font-size: 9px;
      color: var(--sub-text-color);
      font-weight: 500;
    }

    .status-text.active { color: var(--primary-color); }

    .theme-selector { position: relative; }

    .theme-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }

    .theme-dot[data-theme="purple"] { background: #CDB4DB; }
    .theme-dot[data-theme="blue"] { background: #A8DADC; }
    .theme-dot[data-theme="pink"] { background: #FFB3C1; }
    .theme-dot[data-theme="green"] { background: #B8E0B8; }
    .theme-dot[data-theme="yellow"] { background: #FFD97D; }
    .theme-dot[data-theme="gray"] { background: #B8B8B8; }

    .theme-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: white;
      border-radius: 8px;
      padding: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      display: none;
      gap: 8px;
      z-index: 1000;
    }
    .theme-dropdown.show { display: flex; }

    .theme-option {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
    }
    .theme-option[data-theme="purple"] { background: #CDB4DB; }
    .theme-option[data-theme="blue"] { background: #A8DADC; }
    .theme-option[data-theme="pink"] { background: #FFB3C1; }
    .theme-option[data-theme="green"] { background: #B8E0B8; }
    .theme-option[data-theme="yellow"] { background: #FFD97D; }
    .theme-option[data-theme="gray"] { background: #B8B8B8; }

    .project-card {
      background: white;
      border-radius: 8px;
      padding: 14px 12px;
      border: 1px solid var(--border-color);
      min-height: 100px;
    }

    .project-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 16px;
      gap: 8px;
    }

    .project-title {
      font-size: 14px;
      font-weight: 600;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .project-actions { display: flex; gap: 2px; }

    .icon-btn {
      width: 24px;
      height: 24px;
      border: none;
      background: none;
      cursor: pointer;
      color: var(--sub-text-color);
      font-size: 14px;
    }

    .timer-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .timer-time {
      font-size: 28px;
      font-weight: 300;
      font-variant-numeric: tabular-nums;
    }

    .timer-btn {
      padding: 8px 20px;
      border: 1px solid var(--border-color);
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
    }

    .timer-btn.primary {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .navigation {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
    }

    .nav-bar {
      display: flex;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 4px;
      gap: 4px;
    }

    .nav-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 12px;
      color: var(--sub-text-color);
    }

    .nav-btn:disabled { opacity: 0.3; }

    .nav-selector {
      flex: 1;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: white;
      border-radius: 12px;
      padding: 16px;
      width: 100%;
      max-width: 280px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    .modal-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 14px;
    }

    .modal-input {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 13px;
      margin-bottom: 14px;
      font-family: 'Inter', sans-serif;
    }

    .modal-buttons { display: flex; gap: 8px; }

    .modal-btn {
      flex: 1;
      padding: 10px;
      border: 1px solid var(--border-color);
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
    }

    .modal-btn.primary {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .modal-btn.danger {
      background: #ff6b6b;
      color: white;
      border-color: #ff6b6b;
    }

    .project-dropdown {
      position: fixed;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      padding: 6px;
      max-height: 240px;
      overflow-y: auto;
      z-index: 100;
      display: none;
      min-width: 200px;
    }

    .project-dropdown.active { display: block; }

    .project-dropdown-item {
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .project-dropdown-item:hover { background: var(--hover-bg); }

    .project-dropdown-item.active {
      background: var(--primary-color);
      color: white;
    }

    .project-dropdown-name {
      font-size: 13px;
      font-weight: 500;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .project-dropdown-time {
      font-size: 11px;
      color: var(--sub-text-color);
    }

    .project-dropdown-item.active .project-dropdown-time { color: rgba(255,255,255,0.8); }

    .project-dropdown-divider { height: 1px; background: var(--border-color); margin: 4px 0; }

    .project-dropdown-add {
      padding: 10px 12px;
      cursor: pointer;
      display: flex;
      gap: 8px;
      font-size: 13px;
      font-weight: 600;
      color: var(--sub-text-color);
    }

    .empty-state { text-align: center; padding: 30px 12px; }
    .empty-state-icon { font-size: 28px; opacity: 0.3; margin-bottom: 10px; }
    .empty-state-text { font-size: 11px; color: var(--sub-text-color); }

    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text-color);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      z-index: 2000;
      display: none;
    }

    .toast.active { display: block; }
  </style>
</head>
<body data-theme="purple">
  <div class="widget-container">
    <div class="widget-header">
      <h2>
        <span>Time Tracker</span>
        <div class="timer-status-indicator">
          <div class="status-dot" id="statusDot"></div>
          <div class="status-text" id="statusText">STOPPED</div>
        </div>
      </h2>
      <div class="theme-selector">
        <div class="theme-dot" data-theme="purple" id="themeDot"></div>
        <div class="theme-dropdown" id="themeDropdown">
          <div class="theme-option" data-theme="purple"></div>
          <div class="theme-option" data-theme="blue"></div>
          <div class="theme-option" data-theme="pink"></div>
          <div class="theme-option" data-theme="green"></div>
          <div class="theme-option" data-theme="yellow"></div>
          <div class="theme-option" data-theme="gray"></div>
        </div>
      </div>
    </div>

    <div id="projectCardContainer"></div>

    <div class="navigation">
      <div class="nav-bar">
        <button class="nav-btn" id="prevBtn" disabled>◀</button>
        <button class="nav-selector" id="navSelector">
          <span id="navSelectorText">Projects</span>
        </button>
        <button class="nav-btn" id="nextBtn" disabled>▶</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-title" id="modalTitle"></div>
      <input type="text" class="modal-input" id="modalInput">
      <div class="modal-buttons" id="modalButtons"></div>
    </div>
  </div>

  <div class="project-dropdown" id="projectDropdown"></div>
  <div class="toast" id="toast"></div>

  <script>
    const state = { projects: [], currentIndex: 0, activeTimer: null, dropdownOpen: false };

    function loadData() {
      const saved = localStorage.getItem('timeTrackerData');
      state.projects = saved ? JSON.parse(saved).map(p => ({...p, isRunning: false, startTime: null})) : [];
    }

    function saveData() {
      localStorage.setItem('timeTrackerData', JSON.stringify(state.projects.map(p => ({name: p.name, totalTime: p.totalTime}))));
    }

    function formatTime(s) {
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = s % 60;
      return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    }

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('active');
      setTimeout(() => toast.classList.remove('active'), 2500);
    }

    function updateStatus() {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      const running = state.projects.some(p => p.isRunning);
      if (running) {
        dot.classList.add('active');
        text.classList.add('active');
        text.textContent = 'RUNNING';
      } else {
        dot.classList.remove('active');
        text.classList.remove('active');
        text.textContent = 'STOPPED';
      }
    }

    function showModal(title, placeholder, onConfirm, danger = false) {
      const overlay = document.getElementById('modalOverlay');
      const input = document.getElementById('modalInput');
      document.getElementById('modalTitle').textContent = title;
      input.style.display = danger ? 'none' : 'block';
      input.value = '';
      input.placeholder = placeholder;
      
      const btns = document.getElementById('modalButtons');
      btns.innerHTML = `
        <button class="modal-btn" onclick="document.getElementById('modalOverlay').classList.remove('active')">Cancel</button>
        <button class="modal-btn ${danger?'danger':'primary'}" id="confirmBtn">${danger?'Delete':'Confirm'}</button>
      `;
      
      document.getElementById('confirmBtn').onclick = () => {
        onConfirm(input.value);
        overlay.classList.remove('active');
      };
      
      overlay.classList.add('active');
      if (!danger) setTimeout(() => input.focus(), 100);
    }

    function renderCard() {
      const container = document.getElementById('projectCardContainer');
      const text = document.getElementById('navSelectorText');
      const prev = document.getElementById('prevBtn');
      const next = document.getElementById('nextBtn');

      if (state.projects.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">⏱</div><div class="empty-state-text">Start tracking your time by creating a project</div></div>';
        text.textContent = 'New Project';
        prev.disabled = next.disabled = true;
        updateStatus();
        return;
      }

      const p = state.projects[state.currentIndex];
      text.textContent = `${state.currentIndex + 1} / ${state.projects.length}`;
      prev.disabled = state.currentIndex === 0;
      next.disabled = state.currentIndex === state.projects.length - 1;

      container.innerHTML = `
        <div class="project-card">
          <div class="project-header">
            <div class="project-title">${p.name}</div>
            <div class="project-actions">
              <button class="icon-btn" onclick="resetTimer()">↻</button>
              <button class="icon-btn" onclick="editProject()">✎</button>
              <button class="icon-btn" onclick="deleteProject()">✕</button>
            </div>
          </div>
          <div class="timer-container">
            <div class="timer-time" id="timerDisplay">${formatTime(p.totalTime)}</div>
            <button class="timer-btn ${p.isRunning?'primary':''}" onclick="${p.isRunning?'stopTimer()':'startTimer()'}">
              ${p.isRunning?'Stop':'Start'}
            </button>
          </div>
        </div>
      `;
      updateStatus();
    }

    function renderDropdown() {
      const dd = document.getElementById('projectDropdown');
      if (state.projects.length === 0) {
        dd.innerHTML = '<div class="project-dropdown-add" onclick="addProject();toggleDropdown(event)"><span>+</span><span>New Project</span></div>';
        return;
      }
      dd.innerHTML = state.projects.map((p, i) => 
        `<div class="project-dropdown-item ${i===state.currentIndex?'active':''}" onclick="selectProject(${i})">
          <div class="project-dropdown-name">${p.name}</div>
          <div class="project-dropdown-time">${formatTime(p.totalTime)}</div>
        </div>`
      ).join('') + '<div class="project-dropdown-divider"></div><div class="project-dropdown-add" onclick="addProject();toggleDropdown(event)"><span>+</span><span>New Project</span></div>';
    }

    function toggleDropdown(e) {
      e.stopPropagation();
      const dd = document.getElementById('projectDropdown');
      const btn = document.getElementById('navSelector');
      state.dropdownOpen = !state.dropdownOpen;
      if (state.dropdownOpen) {
        renderDropdown();
        const rect = btn.getBoundingClientRect();
        dd.style.bottom = `${window.innerHeight - rect.top + 4}px`;
        dd.style.left = `${rect.left}px`;
        dd.style.width = `${rect.width}px`;
        dd.classList.add('active');
      } else {
        dd.classList.remove('active');
      }
    }

    function selectProject(i) {
      if (state.projects[state.currentIndex]?.isRunning) stopTimer();
      state.currentIndex = i;
      state.dropdownOpen = false;
      document.getElementById('projectDropdown').classList.remove('active');
      renderCard();
    }

    function startTimer() {
      const p = state.projects[state.currentIndex];
      p.isRunning = true;
      p.startTime = Date.now();
      state.activeTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - p.startTime) / 1000);
        const display = document.getElementById('timerDisplay');
        if (display) display.textContent = formatTime(p.totalTime + elapsed);
      }, 1000);
      renderCard();
    }

    function stopTimer() {
      const p = state.projects[state.currentIndex];
      if (p.isRunning && p.startTime) {
        p.totalTime += Math.floor((Date.now() - p.startTime) / 1000);
        p.isRunning = false;
        p.startTime = null;
        clearInterval(state.activeTimer);
        state.activeTimer = null;
        saveData();
        renderCard();
        renderDropdown();
        showToast('Time saved successfully');
      }
    }

    function resetTimer() {
      const p = state.projects[state.currentIndex];
      if (p.isRunning) { showToast('Stop the timer first'); return; }
      if (p.totalTime === 0) { showToast('Already at 00:00:00'); return; }
      showModal('Reset Timer', '', (input) => {
        if (input === 'RESET') {
          p.totalTime = 0;
          saveData();
          renderCard();
          renderDropdown();
          showToast('Timer reset');
        }
      }, true);
      document.getElementById('modalTitle').textContent = `Reset "${p.name}"? Type RESET to confirm`;
    }

    function addProject() {
      showModal('Add New Project', 'e.g., Website Redesign', (name) => {
        if (name.trim()) {
          state.projects.push({name: name.trim(), totalTime: 0, isRunning: false, startTime: null});
          state.currentIndex = state.projects.length - 1;
          saveData();
          renderCard();
          showToast('Project created');
        }
      });
    }

    function editProject() {
      const p = state.projects[state.currentIndex];
      showModal('Edit Project', p.name, (name) => {
        if (name.trim()) {
          p.name = name.trim();
          saveData();
          renderCard();
          renderDropdown();
          showToast('Project updated');
        }
      });
      document.getElementById('modalInput').value = p.name;
    }

    function deleteProject() {
      const p = state.projects[state.currentIndex];
      showModal('Delete Project', '', () => {
        if (p.isRunning) stopTimer();
        state.projects.splice(state.currentIndex, 1);
        state.currentIndex = Math.max(0, Math.min(state.currentIndex, state.projects.length - 1));
        saveData();
        renderCard();
        renderDropdown();
        showToast('Project deleted');
      }, true);
      document.getElementById('modalTitle').textContent = `Delete "${p.name}"?`;
    }

    document.getElementById('prevBtn').onclick = () => {
      if (state.currentIndex > 0) {
        if (state.projects[state.currentIndex]?.isRunning) stopTimer();
        state.currentIndex--;
        renderCard();
      }
    };

    document.getElementById('nextBtn').onclick = () => {
      if (state.currentIndex < state.projects.length - 1) {
        if (state.projects[state.currentIndex]?.isRunning) stopTimer();
        state.currentIndex++;
        renderCard();
      }
    };

    document.getElementById('navSelector').onclick = toggleDropdown;

    document.getElementById('modalOverlay').onclick = (e) => {
      if (e.target.id === 'modalOverlay') e.target.classList.remove('active');
    };

    document.onclick = () => {
      if (state.dropdownOpen) {
        state.dropdownOpen = false;
        document.getElementById('projectDropdown').classList.remove('active');
      }
    };

    const themeDot = document.getElementById('themeDot');
    const themeDropdown = document.getElementById('themeDropdown');
    themeDot.onclick = (e) => {
      e.stopPropagation();
      themeDropdown.classList.toggle('show');
    };

    document.querySelectorAll('.theme-option').forEach(opt => {
      opt.onclick = (e) => {
        e.stopPropagation();
        const theme = opt.dataset.theme;
        document.body.dataset.theme = theme;
        themeDot.dataset.theme = theme;
        localStorage.setItem('timeTrackerTheme', theme);
        themeDropdown.classList.remove('show');
      };
    });

    const savedTheme = localStorage.getItem('timeTrackerTheme') || 'purple';
    document.body.dataset.theme = savedTheme;
    themeDot.dataset.theme = savedTheme;

    loadData();
    renderCard();
  </script>
</body>
</html>
